name: Collect Repositories

on:
  schedule:
    - cron: '0 */6 * * *' # A cada 6 horas
  workflow_dispatch:
    inputs:
      users:
        description: 'Usu√°rios para coletar (separados por v√≠rgula)'
        required: false
        default: 'felipemacedo1,growthfolio'

permissions:
  contents: write

jobs:
  collect:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: Build repos collector
        run: |
          set -euo pipefail
          echo "üî® Building repos_collector..."
          go build -o bin/repos_collector scripts/collectors/repos_collector.go
          echo "‚úì Build completed"

      - name: Collect repositories data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
        run: |
          set -euo pipefail
          echo "üì° Collecting repositories..."
          ./bin/repos_collector
          echo "‚úì Collection completed"

      - name: Validate generated files
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -qq
            sudo apt-get install -y jq
          fi
          
          echo "‚úì Validating data/projects.json..."
          jq empty data/projects.json
          REPOS=$(jq 'length' data/projects.json)
          echo "  Found $REPOS repositories"
          
          echo "‚úì Validating data/metadata.json..."
          jq empty data/metadata.json
          echo "  Version: $(jq -r '.version' data/metadata.json)"

      - name: Commit and push changes
        run: |
          set -euo pipefail
          
          git config user.name "felipemacedo1 [bot]"
          git config user.email "felipealexandrej@gmail.com"

          if git status --porcelain | grep -qE "data/(projects|metadata).json"; then
            echo "üìù Changes detected in repository data"
            git add data/projects.json data/metadata.json
            
            REPOS=$(jq 'length' data/projects.json)
            git commit -m "chore: update repositories data ($REPOS repos) [skip ci]"

            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git push origin HEAD:main
            echo "‚úì Changes pushed successfully"
          else
            echo "‚ÑπÔ∏è  No changes to commit"
          fi
